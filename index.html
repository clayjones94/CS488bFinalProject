<!DOCTYPE html>
<html>
<head>
	<script src="https://d3js.org/d3.v4.min.js"></script>
</script>
    <style>
        body {font-family: monospace; line-height: 160%; font-size: 18px; }
        ul {list-style: none; margin: 0; padding: 0; display: inline-block;}
        li {display: block; min-width: 80px; padding: 10px; margin: 0;}
        input {border: 1px dotted #ccc; background: white; font-family: monospace; padding: 10px 20px; font-size: 18px; margin: 20px 10px 20px 0; color: gray;}
        input:focus { background-color:lightgray; outline: none;}
    </style>
</head>
<body>
 	<form name="myform" onSubmit="return handleClick()">
        <input name="Submit"  type="submit" value="Add to list" >
        <input type="text" id="myVal" placeholder="Add some text&hellip;">
    </form>
	<div	id="visualization_area"></div>	
	<ul id="overall_list"></ul>
	<ul id="individual_list"></ul>
	<div	id="text_area"></div>	
	<script>

		var WIDTH = 900;
		var HEIGHT = 400;
	    var MARGINS = {
	      top: 20,
	      right: 50,
	      bottom: 20,
	      left: 50
	    };

	    var trumpWords = {};
	    var hillaryWords = {};
	    var mostInfluentialWordsAlone = [];
	    var mostInfluentialWordsOverall = [];
		var graph;
		var yValues = [];
		var xScale;
		var yScale;
		var xAxis;
		var yAxis;
		var inputText;
		var inputWords;
		loadData();
		layoutGraph();

		function loadData () {
			d3.csv("./trumpWords.csv", function(error, data) {
				if (error) {
				  // Handle error if there is any
					return console.warn(error);
				}
			  	formatTrump(data);
			});
			d3.csv("./hillaryWords.csv", function(error, data) {
				if (error) {
				  // Handle error if there is any
					return console.warn(error);
				}
			  	formatHillary(data);
			});
		}

		function formatTrump(data) {
			for (var i = 0; i < data.length; i++) {
				var entry = data[i];
				var word = entry["word"];
				var weight = entry["weight"];
				trumpWords[word] = parseFloat(weight);
			};
		};

		function formatHillary(data) {
			for (var i = 0; i < data.length; i++) {
				var entry = data[i];
				var word = entry["word"];
				var weight = entry["weight"];
				hillaryWords[word] = parseFloat(weight);
			};
		};

		function layoutGraph() {

		    graph =	d3.select("#visualization_area")										
				.append("svg")												
				.attr("width",	WIDTH)												
				.attr("height",	HEIGHT);	

			xScale = d3.scaleLinear()
						.range([MARGINS.left, WIDTH - MARGINS.right])
						.domain([0,100]),

			yScale = d3.scaleLinear()
						.range([HEIGHT - MARGINS.top, MARGINS.bottom])
						.domain([-10,10]),

			xAxis = d3.axisBottom(xScale),
			  
			yAxis = d3.axisLeft(yScale);

			text_area = d3.select("#text_area")										
							.append("svg")												
							.attr("width",	WIDTH)												
							.attr("height",	120);

			graph.append("svg:g")
				.attr("class","xaxis")
				.attr("transform", "translate(0," + (HEIGHT - MARGINS.bottom) + ")")
			    .call(xAxis);

			graph.append('svg:g')
				.attr("class","yaxis")
				.attr("transform", "translate(" + (MARGINS.left) + ",0)")
			  	.call(yAxis);
		};

		function displayLines() {

			d3.selectAll("path")
		        		.remove();

			var maxY = -1;
			for (var i = 0; i < yValues.length; i++) {
				var yVal = yValues[i];
				if (Math.abs(yVal) > maxY) {
					maxY = Math.abs(yVal);
				};
			};

			var newxScale = d3.scaleLinear()
						.range([MARGINS.left, WIDTH - MARGINS.right])
						.domain([0,yValues.length-1]);

			var newyScale = d3.scaleLinear()
						.range([HEIGHT - MARGINS.top, MARGINS.bottom])
						.domain([- maxY - maxY * .1,maxY + maxY * .1]);

			var newxAxis = d3.axisBottom(newxScale);
			  
			var newyAxis = d3.axisLeft(newyScale);

		   	var xAx = d3.selectAll(".yaxis")
		        		.call(newyAxis);

		   	var yAx = d3.selectAll(".xaxis")
		        		.call(newxAxis);

			var lineGen = d3.line()
			    .x(function(d, i) {
			        return newxScale(i);
			    })
			    .y(function(d) {
			        return newyScale(d);
			    });

			var line = graph.append('path')
							.attr('d', lineGen(yValues))
							.attr('stroke', 'purple')
							.attr('stroke-width', 5)
							.attr('fill', 'none')
							.attr('id', "path")
							.attr('name', name);
		}
 
        function handleClick(event){
        	inputText = document.getElementById("myVal").value;
        	inputWords = [];
        	inputWords = inputText.split(/[.,\/ -]/);
            calculateCandidate();
            calculateMostInfluentialWords([hillaryWords, trumpWords]);
            draw();
            return false;
        }

        function printWords() {
        	console.log(mostInfluentialWordsAlone);
        	console.log(mostInfluentialWordsOverall);
        	for(var val in mostInfluentialWordsAlone){
        		var wordObj = mostInfluentialWordsAlone[val];
        		console.log(wordObj.word + " " + wordObj.weight);
        	}
        	for(var val in mostInfluentialWordsOverall){
        		var wordObj = mostInfluentialWordsOverall[val];
        		console.log(wordObj.word + " " + wordObj.weight);
        	}

        }

        function draw(val){
        	for(var val in mostInfluentialWordsAlone){
        		var wordObj = mostInfluentialWordsAlone[val];
        		console.log(wordObj.word + " " + wordObj.weight);
        		d3.select("body").select("#individual_list").append("li");
        	}
        	var p = d3.select("body").selectAll("li")
        			.data(mostInfluentialWordsAlone)
        			.text(function(d,i){return i + ": " + d.word + " - " + d.weight;})
        	
        	for(var val in mostInfluentialWordsOverall){
        		var wordObj = mostInfluentialWordsOverall[val];
        		console.log(wordObj.word + " " + wordObj.weight);
        		d3.select("body").select("#overall_list").append("li");
        	}
        	var np = d3.select("body").selectAll("li")
        			.data(mostInfluentialWordsOverall)
        			.text(function(d,i){return i + ": " + d.word + " - " + d.weight;})
        }

        function calculateCandidate (){
        	var yValue = 0.0;
        	yValues = [];
        	for (var i = 0; i < inputWords.length; i++) {
        		var word = inputWords[i];
        		if (word.length < 1) continue;
        		if (isTrumpWord(word)) {
        			yValue += trumpWords[word];
        		} else if (isHillaryWord(word)) {
        			yValue -= hillaryWords[word];
        		}
        		yValues[i] = yValue;
        	};

        	displayLines();

        }

        function isHillaryWord(word){
			if (hillaryWords[word] != null) return true;
			return false;
		}

		function isTrumpWord(word){
			if (trumpWords[word] != null) return true;
			return false;
		}

		function calculateMostInfluentialWords (wordMaps){
			var wordScores = {};
			var aloneWords = [];
			var overallWords = [];

			for (var i = 0; i < inputWords.length; i++) {
				var w = inputWords[i];
				if (w.length < 1) continue;
		                for (var j = 0; j < wordMaps.length; j++) {
		                        wordMap = wordMaps[j];
		                        var score = wordMap[w];
		                        if (score != null) {
		                                if (wordScores[w] == null) {
		                                        wordScores[w] = parseFloat(score);
		                                } else {
		                                        wordScores[w] += parseFloat(score);
		                                }
		                                var inserted = false;
		                                for (var k = 0; k < aloneWords.length; k++) {
		                                        if(aloneWords[k].weight < score) {
		                                                aloneWords.splice(k, 0, {word: w, weight:score});
		                                                inserted = true;
		                                                break;
		                                        }
		                                }
		                                if (!inserted && aloneWords.length < 10) {
		                                      aloneWords.push({word: w, weight:score}); 
		                                };
		                                if (aloneWords.length > 10) {
		                                        aloneWords.splice(-1,1);
		                                }
		                        }   
		                };
			};
	    	for(var val in wordScores){
	                var inserted = false;
	                score = wordScores[val];
	                for (var k = 0; k < overallWords.length; k++) {
	                        if(overallWords[k].weight < score) {
	                                overallWords.splice(k, 0, {word: val, weight:score});
	                                inserted = true;
	                                break;
	                        }
	                }
	                if (!inserted && overallWords.length < 10) {
	                      overallWords.push({word: val, weight:score}); 
	                };
	                if (overallWords.length > 10) {
	                        overallWords.splice(-1,1);
	                }
	        }
	       	mostInfluentialWordsAlone = aloneWords;
		    mostInfluentialWordsOverall = overallWords;
		}

	</script>
</body>
</html>